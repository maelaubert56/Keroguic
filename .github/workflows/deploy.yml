# A name for our Workflow
name: Deploy Static Site

# Specifies that the workflow should be triggered on a Git push event.
on:
  push:
    branches:
      # Specifies the branches on which the workflow should be triggered
      - prod

# Defines the jobs to be executed as part of the workflow
jobs:
  # The name of the job, in this case, "Deploy."
  Deploy:
    # Specifies that the job should run on the latest version of the Ubuntu operating system.
    runs-on: ubuntu-latest
    
    # Lists the individual steps to be executed within the job.
    steps:
      # Checks out the source code repository into the runner's workspace using the `actions/checkout@v2` GitHub Action.
      - name: Checkout Repository
        uses: actions/checkout@v2
      
      # Adds an SSH private key to the SSH agent
      - name: Add SSH Key to Agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      # Performs the actual deployment.
      # It consists of a multi-line script (run:) Prints the current working directory and lists its contents.
      # Outputs a message indicating the start of the deployment.
      # Use SSH to connect to the server (${{ secrets.SSH_HOST }}) with the specified port, user, and private key. It then changes to the deployment directory (/var/www/keroguic), removes existing contents, and exits.
      # Use scp to securely copy the contents of the local directory to the specified deployment directory on the server.
      # Outputs a message indicating the completion of the deployment.
      - name: Deploy Site to Server
        run: |
          echo "Current Working Directory: $(pwd)"
          echo "Contents of the directory: $(ls -la)"
          echo "Starting deployment....."
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cd /var/www/keroguic && rm -rf * && exit"
          scp -o StrictHostKeyChecking=no -P ${{ secrets.SERVER_PORT }} -r ./* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/keroguic
          echo "Deployment completed."
